<script type="text/javascript">
    RED.nodes.registerType('watchdog',{
        category: 'Kubernetes',
        color: '#FDF0C2',
        defaults: {
            name: {
                value:""
            },
            condition: {
                value:"",
                required:true
            },
            fulfilled: {
                value:"true",
                required:true
            }
        },
        oneditprepare: function () {
            var node = this;
            var candidateNodes = RED.nodes.filterNodes({z:node.z});
            var s = "";
            var cntHealthChecks = 0;
            var theHealthCheck = this;

            candidateNodes.forEach(function(n) {
                if (n.id === node.id) {
                    return;
                }
                var nodeDef = RED.nodes.getType(n.type);
                if (nodeDef) {
                    var sublabel = n.type;

                    if (sublabel.indexOf("subflow:") === 0) {
                        var subflowId = sublabel.substring(8);
                        var subflow = RED.nodes.subflow(subflowId);
                        sublabel = "subflow : "+subflow.name;
                    }
                    s = s + "<br>" + sublabel;

                    if (sublabel === 'health checks') {
                        cntHealthChecks++;
                        theHealthCheck = n;
                    }

                }
            });

            switch(cntHealthChecks) {
                case 0:
                    $('#error-box').html("No <strong>health checks</strong> node found at all!");
                    return;
                case 1:
                    // okay
                    $("#error-box").hide();
                    break;
                default:
                    $('#error-box').html("More than one <strong>health checks</strong> node found!");
                    return;
            }

            var makeTypedInputOpt = function(value){
                return {
                    value: value,
                    label: value
                }
            }

            var contentTypeOpts = [];
            theHealthCheck.conditions.forEach(function(c) {
                contentTypeOpts.push(makeTypedInputOpt(c));
            });

            $("#node-input-condition").typedInput({
                types: [
                    {
                        value: "condition",
                        options: contentTypeOpts
                    }
                ]
            });

            $("#node-input-fulfilled").typedInput({
                types: [
                    {
                        value: "fulfilled",
                        options: [
                            { value: "true", label: "fulfilled"},
                            { value: "false", label: "NOT fulfilled"}
                        ]
                    }
                ]
            });
        },
        inputs:1,
        outputs:0,
        align: 'left',
        icon: function() {
            return (this.fulfilled === "true") ? "checked.png" : "unchecked.png";
        },
        label: function() {
            return this.name || ((this.condition === "") ? "watchdog" : (("watchdog: " + this.condition + ((this.fulfilled === "true") ? " is fulfilled" : " is NOT fulfilled"))));
        }
    });
</script>

<script type="text/html" data-template-name="watchdog">
    <style>
        .watchdog-form-row-cols2 > input.watchdog-form-row-col1 {
            width: calc(35% - 75px);
        }
        .watchdog-form-row-cols2 > select.watchdog-form-row-col1 {
            width: calc(35% - 75px);
        }

        .watchdog-form-row-cols2 > label.watchdog-form-row-col2 {
            width: 50px;
            margin-left: 10px;
            display: inline-block;
        }
        .watchdog-form-row-cols2 > input.watchdog-form-row-col2 {
            width: calc(35% - 75px);
            display: inline-block;
        }
        .watchdog-form-row-cols2 > select.watchdog-form-row-col2 {
            width: calc(35% - 75px);
            display: inline-block;
        }
    </style>

    <div class="form-row" id="error-box">
    </div>

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>


    <div class="form-row watchdog-form-row-cols2">
        <label for="node-input-condition" class="watchdog-form-row-col1">Set condition</label>
        <input type="text" id="node-input-condition" class="watchdog-form-row-col1">

        <label for="node-input-fulfilled" class="watchdog-form-row-col2">is</label>
        <input type="text" id="node-input-fulfilled" class="watchdog-form-row-col2">
    </div>

</script>

<script type="text/html" data-help-name="watchdog">
    <p>This node provides the <strong>health checks</strong> node with information about the status of the flow.</p>
</script>
